user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    map $http_user_agent $prerender_ua {
        default       0;
        "~*Prerender" 0;

        "~*googlebot"                               1;
        "~*yahoo!\ slurp"                           1;
        "~*bingbot"                                 1;
        "~*yandex"                                  1;
        "~*baiduspider"                             1;
        "~*facebookexternalhit"                     1;
        "~*twitterbot"                              1;
        "~*rogerbot"                                1;
        "~*linkedinbot"                             1;
        "~*embedly"                                 1;
        "~*quora\ link\ preview"                    1;
        "~*showyoubot"                              1;
        "~*outbrain"                                1;
        "~*pinterest\/0\."                          1;
        "~*developers.google.com\/\+\/web\/snippet" 1;
        "~*slackbot"                                1;
        "~*vkshare"                                 1;
        "~*w3c_validator"                           1;
        "~*redditbot"                               1;
        "~*applebot"                                1;
        "~*whatsapp"                                1;
        "~*flipboard"                               1;
        "~*tumblr"                                  1;
        "~*bitlybot"                                1;
        "~*skypeuripreview"                         1;
        "~*nuzzel"                                  1;
        "~*discordbot"                              1;
        "~*google\ page\ speed"                     1;
        "~*qwantify"                                1;
        "~*pinterestbot"                            1;
        "~*bitrix\ link\ preview"                   1;
        "~*xing-contenttabreceiver"                 1;
        "~*chrome-lighthouse"                       1;
        "~*telegrambot"                             1;
        "~*google-inspectiontool"                   1;
        "~*petalbot"                                1;
        "~*ddoaudit-test-bot"                       1;
        "~*staging-test-crawler"                    1;
        "~*prerender-test"                          1;
        # Added common crawlers and preview bots
        "~*duckduckbot"                             1;
        "~*dotbot"                                  1; # Moz (successor to rogerbot)
        "~*ahrefs(bot|siteaudit)"                   1;
        "~*semrush(bot)?"                           1;
        "~*ccbot"                                   1; # Common Crawl
        "~*mj12bot"                                 1; # Majestic
        "~*blexbot"                                 1;
        "~*exabot"                                  1; # Exalead
        "~*sogou"                                   1;
        "~*seznambot"                               1;
        "~*(yeti|naverbot)"                         1; # Naver
        "~*ia_archiver"                             1; # Alexa/Internet Archive
        "~*bytespider"                              1; # ByteDance/TikTok
        "~*bingpreview"                             1; # Bing link preview fetcher
        "~*facebot"                                 1; # Alternate Facebook UA
        "~*slack\-imgproxy"                         1; # Slack image unfurl fetcher
        "~*duckduckgo\-favicons\-bot"               1;
        # Newer/infra Google/Bing variants
        "~*googleother"                             1;
        "~*googlereadaloud"                         1;
        "~*apis\-google"                            1;
        "~*adsbot\-google"                          1; # Optional: ads crawler
        "~*mediapartners\-google"                   1; # Optional: AdSense crawler
    }

    map $args $prerender_args {
        default $prerender_ua;
        "~(^|&)_escaped_fragment_=" 1;
    }

    map $http_x_prerender $x_prerender {
        default $prerender_args;
        "1"     0;
    }

    map $uri $prerender {
        default $x_prerender;
        "~*\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|woff2|svg|eot)" 0;
    }

    include /etc/nginx/conf.d/*.conf;

    ssl_prefer_server_ciphers on;
    ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    add_header Strict-Transport-Security "max-age=15768000" always;
}